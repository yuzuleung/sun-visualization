# 眠らない地球 — API データで描く都市の灯火

世界の主要都市の日出日没時刻をリアルタイム API から取得し、夜間に都市を点灯させるインタラクティブなデータビジュアライゼーション

## コンセプト

本プロジェクトは、地球上の時間の流れと昼夜の変化を視覚的に表現する Web アプリケーションです。現実世界の天文データを基に、各都市の夜間に「灯火」が点灯する様子をアニメーションで描写し、地球が「眠らない惑星」であることを表現します。
世界中の 21 ヶ国 53 都市を選択し、各大陸の主要国家から代表的都市を選定。極地地域（南極・北極圏）から赤道地域まで幅広い緯度帯をカバーし、地球全体の昼夜サイクルと季節変化を包括的に表現します。

### プロジェクトの意図

- **時間の可視化**: 世界各地の時差と昼夜サイクルの理解促進
- **データドリブンアート**: 科学的データを美しいビジュアルに変換
- **教育的価値**: 地理・天文学習ツールとしての活用
- **技術実証**: 現代的な Web API 統合とモジュラー設計の実践

### 主要機能

- **グローバル都市ネットワーク**: 世界 21 ヶ国 53 都市を対象とした包括的データセット
  - **主要国家**: 日本、アメリカ、中国、オーストラリア、ドイツ、イギリス、フランス等
  - **極地地域**: 南極 McMurdo 基地、グリーンランド Ilulissat 等の極限環境
  - **赤道地域**: Quito、Bogotá 等赤道付近都市
  - **全緯度帯**: 地球全体全緯度帯をカバー
- **リアルタイム日出日没データ**: Open-Meteo Archive API から 365 日分の実際の天文データを取得
- **動的都市点灯**: 各都市の夜間時間帯に金色の灯火で自動点灯
- **インタラクティブアニメーション**:
  - 24 時間サイクル再生（4 秒 ≈1 時間）
  - 年間サイクル再生（80ms≈1 日）
- **国別フィルタリング**: 21 ヶ国 53 都市から特定国家の詳細表示
- **極地対応**: 白夜・極夜現象の正確な再現

### ビジュアル要素

- **地図投影**: d3.geoNaturalEarth1 による美しい世界地図
- **都市マーカー**: 知能的ラベル配置で重複回避
- **夜間エフェクト**: 金色の光輝エフェクトによる夜間表現
- **レスポンシブデザイン**: 様々な画面サイズに対応

## 利用 API・技術スタック

### 外部 API

- **Open-Meteo Archive API**:
  - **用途**: 世界各都市の年間日出日没時刻データ取得
  - **特徴**: 無料、高精度、タイムゾーン対応
  - **エンドポイント**: `https://archive-api.open-meteo.com/v1/archive`

### 技術構成

- **フロントエンド**:
  - HTML5/CSS3/ES6+ JavaScript
  - D3.js v7 (地図描画・データビジュアライゼーション)
  - TopoJSON (地理データ処理)
- **アーキテクチャ**: ES6 モジュールシステム
- **データ管理**: ローカルストレージキャッシング、JSON フォールバック

## 処理フロー・処理の意図

### **アプリケーション初期化フロー**

```
┌─────────────────────────────────────────────────────────────────┐
│ 【初期化段階】                                                     │
├─────────────────────────────────────────────────────────────────┤
│ 1. DOM読み込み → D3要素初期化                                      │
│ 2. 世界地図描画 (Natural Earth データ使用)                         │
│ 3. 都市データ読み込み (53都市・21ヶ国)                              │
│ 4. 都市マーカー配置 + 知能的ラベル配置                              │
│ 5. イベントハンドラ設定                                            │
│ 6. 初期データ取得 (API/JSON)                                      │
│ 7. 初期レンダリング実行                                            │
└─────────────────────────────────────────────────────────────────┘
```

### **データ取得・処理フロー**

```
┌─────────────────────────────────────────────────────────────────┐
│ 【データ取得戦略】                                                 │
├─────────────────────────────────────────────────────────────────┤
│ APIリクエスト → CORS制限判定                                       │
│    ├─ 制限あり → JSONフォールバック使用                           │
│    └─ 制限なし → Open-Meteo API呼び出し                          │
│                                                                │
│ データ変換 → ローカルキャッシュ → レンダリング                        │
│                                                                │
│ 【意図】: 安定性重視・オフライン対応・高速化                        │
└─────────────────────────────────────────────────────────────────┘
```

### **昼夜判定ロジック**

```
┌─────────────────────────────────────────────────────────────────┐
│ 【昼夜判定処理】                                                   │
├─────────────────────────────────────────────────────────────────┤
│ 1. UTC時刻変換: ローカル日出日没時刻 → UTC基準変換                   │
│                                                                │
│ 2. 極地特殊処理:                                                  │
│    ├─ 白夜: 24時間昼間 (McMurdo基地型)                           │
│    └─ 極夜: 24時間夜間 (Ilulissat型)                            │
│                                                                │
│ 3. 日付跨ぎ対応: sunrise > sunset時の正確な処理                    │
│                                                                │
│ 4. 視覚表現: 昼間=暗色小円、夜間=金色大円+輝き                      │
│                                                                │
│ 【意図】: 地球上のあらゆる地点の昼夜を正確に再現                     │
└─────────────────────────────────────────────────────────────────┘
```

### **重要機能: アニメーション制御**

```
┌─────────────────────────────────────────────────────────────────┐
│ 【▶ 再生】ボタン - 24時間サイクルアニメーション                      │
├─────────────────────────────────────────────────────────────────┤
│ • 動作: 毎フレーム6分進行 (4秒 ≈ 1時間)                           │
│ • 効果: 世界中の都市の灯火が時間と共に点灯・消灯                     │
│ • 意図: 地球の自転による昼夜の移り変わりを体感                       │
│ • 学習効果: 時差の概念と同時刻での昼夜分布の理解                     │
└─────────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────────┐
│ 【📅 年間再生】ボタン - 365日サイクルアニメーション                  │
├─────────────────────────────────────────────────────────────────┤
│ • 動作: 毎フレーム1日進行 (80ms ≈ 1日)                            │
│ • 効果: 季節変化による日照時間の変動を可視化                         │
│ • 意図: 地球の公転による季節変化と極地現象の理解                     │
│ • 学習効果: 白夜・極夜現象と緯度による日照時間差の体験               │
└─────────────────────────────────────────────────────────────────┘
```

### **処理の全体的意図**

```
┌─────────────────────────────────────────────────────────────────┐
│ 【プロジェクトの核心的意図】                                        │
├─────────────────────────────────────────────────────────────────┤
│ 1. 時間の可視化                                                   │
│    └─ 抽象的な「時差」概念を直感的なビジュアルで表現               │
│                                                                │
│ 2. 科学教育支援                                                   │
│    └─ 地球科学・天文学の複雑な概念を分かりやすく                   │
│                                                                │
│ 3. データドリブンアート                                            │
│    └─ 現実の天文データから美しいアニメーションを生成               │
│                                                                │
│ 4. 技術実証                                                      │
│    └─ モダンなWeb技術とAPI統合の実践例                           │
└─────────────────────────────────────────────────────────────────┘
```

## プロジェクト構造

```
sun-visualization/
├── index.html              # メインHTML
├── styles.css              # スタイルシート
├── sun-data-fallback.json  # フォールバックデータ
├── js/                     # モジュール化されたJavaScript
│   ├── app.js              # メインアプリケーション
│   ├── config.js           # 設定・定数
│   ├── utils.js            # ユーティリティ関数
│   ├── data-manager.js     # データ管理・API
│   ├── map-renderer.js     # 地図描画
│   ├── animation.js        # アニメーション制御
│   └── ui-controller.js    # UI・イベント処理
└── script-original.js      # 元の統合ファイル (バックアップ)
```

### モジュール責任分離

- **app.js**: アプリケーション統合・初期化
- **config.js**: 設定値・定数・API URL 管理
- **utils.js**: 汎用関数・時刻変換・昼夜判定
- **data-manager.js**: API 呼び出し・データキャッシング
- **map-renderer.js**: D3 地図描画・都市マーカー配置
- **animation.js**: レンダリング・アニメーション制御
- **ui-controller.js**: DOM 操作・イベントハンドリング

## セットアップ・実行手順

### 必要条件

- モダンブラウザ（Chrome, Firefox, Safari, Edge）
- ローカルサーバー（CORS 制限回避のため）

### クイックスタート

1. **リポジトリクローン**

   ```bash
   git clone https://github.com/yuzuleung/sun-visualization.git
   cd sun-visualization
   ```

2. **ローカルサーバー起動**

   **Python 使用**:

   ```bash
   # Python 3
   python3 -m http.server 8080

   # Python 2
   python -m SimpleHTTPServer 8080
   ```

   **Node.js 使用**:

   ```bash
   npx serve -p 8080
   ```

   **PHP 使用**:

   ```bash
   php -S localhost:8080
   ```

3. **ブラウザでアクセス**
   ```
   http://localhost:8080
   ```

### 操作方法

```
┌─────────────────────────────────────────────────────────────────┐
│ 【基本操作】                                                      │
├─────────────────────────────────────────────────────────────────┤
│ 1. 国選択: ドロップダウンから表示したい国を選択                      │
│    └─ ALL = 全都市表示 (53都市)                                  │
│                                                                │
│ 2. 年選択: 2024年 または 2025年 を選択                           │
│                                                                │
│ 3. 日付設定: スライダーで 1-365日 を設定                          │
│                                                                │
│ 4. 時刻設定: UTC時刻をスライダーで調整 (0-23時)                    │
└─────────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────────┐
│ 【重要機能: アニメーション操作】                                    │
├─────────────────────────────────────────────────────────────────┤
│ ▶【再生】ボタン                                                  │
│ ├─ 機能: 24時間サイクルアニメーション                             │
│ ├─ 速度: 4秒で1日を表現 (1フレーム = 6分進行)                     │
│ ├─ 効果: 世界各都市の灯火が時間経過と共に点灯・消灯               │
│ └─ 学習: 地球自転による昼夜の移り変わりを体感                     │
│                                                                │
│ 📅【年間再生】ボタン                                             │
│ ├─ 機能: 365日サイクルアニメーション                             │
│ ├─ 速度: 約30秒で1年を表現 (80ms = 1日)                         │
│ ├─ 効果: 季節変化による日照時間の変動を可視化                     │
│ └─ 学習: 地球公転・季節変化・極地現象 (白夜/極夜) の理解          │
│                                                                │
│ ⏸【停止】ボタン                                                 │
│ └─ 全てのアニメーションを停止、手動操作に戻る                     │
└─────────────────────────────────────────────────────────────────┘
```

## 開発者向け情報

### API テストモード

現在、API レート制限回避のため、JSON フォールバックモードで動作中：

```javascript
// data-manager.js 内
// 一時的にAPI呼び出しをコメントアウト
// return await fetchRealSunTimes(city, year);
return await fetchFromJsonFallback(city, year);
```

### データエクスポート機能

```javascript
// ブラウザコンソールから実行
window.exportAllDataToJson();
```

### トラブルシューティング

- **CORS エラー**: ローカルサーバー使用を確認
- **データ読み込み失敗**: `sun-data-fallback.json`の存在確認
- **アニメーション停止**: ブラウザタブがアクティブか確認

## パフォーマンス特性

- **初期読み込み**: ~2-3 秒（53 都市データ）
- **アニメーション**: 60fps 滑らか再生
- **メモリ使用量**: ~15-20MB
- **キャッシュ効率**: 24 時間持続、重複読み込み回避

## 教育・学術活用

### 学習目標

- 地球の自転と昼夜サイクルの理解
- 世界各地の時差の可視化
- 季節変化と日照時間の関係
- 極地現象（白夜・極夜）の学習

### 授業活用例

- 地理学: 世界の都市と時差の学習
- 物理学: 地球の自転と公転の影響
- 情報学: データビジュアライゼーション実践
- 数学: 三角関数と天文計算
